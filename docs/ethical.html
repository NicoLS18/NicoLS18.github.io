<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Ethical Dilemma – Nicolas Laub-Sabater</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-6bd9cfa162949bde0a231f530c97869d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Nicolas Laub-Sabater</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-data-viz" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Data Viz</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-data-viz">    
        <li>
    <a class="dropdown-item" href="./tt2.html">
 <span class="dropdown-text">AI Detectors</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Olympics.html">
 <span class="dropdown-text">Olympics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Obama.html">
 <span class="dropdown-text">Obama Tweets</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./simulationproject.html">
 <span class="dropdown-text">Will I ever get a single?? Simulation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ethical.html">
 <span class="dropdown-text">Ethical Dilemma</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content column-page" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Ethical Dilemma</h1>
</div>



<div class="quarto-title-meta column-page">

    
  
    
  </div>
  


</header>


<p>Nicolas Laub-Sabater</p>
<p>04/16/2025</p>
<p>Data Science Ethics&nbsp;</p>
<p><br>
</p>
<p>How can data science exacerbate current inequalities and what can be done to rely on AI but also ensure it is not inadvertently creating a bias.&nbsp;</p>
<p><br>
</p>
<p>Amazon’s now-discontinued AI recruiting tool serves as a powerful example of the unintended consequences AI can have when left unchecked. Designed to streamline and optimize the hiring process, the tool was trained on resumes submitted over a ten-year period—most of which came from men. As a result, it developed a bias against female candidates, downgrading resumes that included terms like “women’s” or references to all-women’s colleges. While the intention behind the program was positive, and it likely would have identified strong candidates, its flawed data input led it to replicate and even amplify existing gender disparities. This issue is especially relevant today: while data anonymity and security are heavily discussed and increasingly regulated, there is still a lack of clear frameworks for ensuring AI is used responsibly. The real challenge lies in holding companies accountable for the societal impacts of their AI systems—particularly when those impacts are subtle, systemic, and not immediately visible.</p>
<p>This is an important lesson, as the biases that are found in the data that we feed the program will inevitably be reproduced by the program as it attempts to match what it has been given. I think an understanding of this concept will be important for preventing future issues but still testing the results of the AI algorithms is crucial to prevent any unintentional harm produced by the AI. This overall issue and the societal impacts of these AI programs fall under the following ethical dilemmas: Consider carefully the ethical implications of choices we make when using data, and the impacts of our work on individuals and society, Recognize and mitigate bias in ourselves and in the data we use. In the Amazon example there was a failure to see the bias in the data they were using which in turn led to an ethical dilemma of how they used the data; another example is one I found on MIT’s tech review page about the use of crime predictive systems.</p>
<p>Predictive policing algorithms, like PredPol, have been criticized for perpetuating systemic racism by relying on biased data sources. Even when developers attempt to reduce bias by using victim reports instead of arrest records, these tools still disproportionately target Black and minority communities. This occurs because victim reports themselves can be influenced by societal biases and disparities in reporting practices. For instance, wealthier white individuals are more likely to report crimes committed by poorer Black individuals, and Black individuals are also more likely to report other Black individuals. These patterns lead algorithms to over-police certain neighborhoods, creating a feedback loop that reinforces existing inequalities. Efforts to adjust these models have shown limited success, highlighting the challenge of mitigating bias in predictive policing. The core issue lies not just in the data but in the structural and social conditions that skew crime data, making it difficult for algorithms to provide fair and accurate predictions.</p>
<p>Similarly this program is utilizing biases for its learning which in turn leads to biases, and as this article pointed out these new biases created a feedback loop. This is a system that is still utilized and again should really be considered more thoughtfully as the impacts this system has on individuals in society is extreme and it promotes the very biases that much of society is actively trying to tear down.&nbsp;</p>
<p><br>
<br>
</p>
<p>Who was measured? Are those individuals representative of the people to whom we’d like to generalize / apply the algorithm?</p>
<p><br>
</p>
<p>Amazon AI Hiring Tool: <strong><br>
</strong>The individuals measured by Amazon’s AI hiring tool were applicants who had previously submitted resumes over a ten-year span, the majority of whom were men already hired by Amazon. These individuals became the data foundation for the algorithm, meaning the system essentially learned from and attempted to replicate the profile of past hires. However, this group is not representative of the broader population of talented job seekers Amazon might want to consider today, especially women and other underrepresented groups. The tool assumed the historical data reflected ideal hiring outcomes, without recognizing that past decisions might have been influenced by implicit biases or systemic exclusions. As a result, the algorithm favored male-associated language and penalized terms like “women’s,” leading to a skewed view of what constitutes a strong candidate. This misalignment between the training data and the intended applicant pool reveals how even well-intentioned AI can perpetuate inequality if the data used to train it isn’t critically evaluated.</p>
<p>Predictive Policing Algorithms:<strong><br>
</strong>In the case of predictive policing tools like those developed by Geolitica (formerly PredPol), the individuals measured are those who have historically been arrested or involved in recorded crime incidents—data that disproportionately comes from heavily policed, often low-income communities of color. These individuals do not represent the total population likely to commit crimes, nor do they reflect a fair cross-section of neighborhoods or demographic groups. Instead, they reflect the biases of decades of discriminatory policing practices. The algorithm then reinforces these patterns, continuously sending law enforcement back into the same areas because of a feedback loop: more police presence leads to more recorded incidents, which justifies further surveillance. This results in a misapplication of the tool, where the very people it targets are not a neutral or complete representation of crime trends but rather a reflection of systemic bias embedded in the data.</p>
<p><br>
</p>
<p>Recognize and mitigate bias in ourselves and in the data we use:</p>
<p>The ethical principle of recognizing and mitigating bias is clearly illustrated in both the Amazon AI hiring tool and predictive policing algorithms, where the underlying data reflected long-standing inequalities. In Amazon’s case, the data came from a predominantly male hiring history, which led the algorithm to develop a preference for resumes resembling those of men—penalizing female-associated terms in the process. Although the system itself was technically proficient, it unknowingly mirrored the company’s past biases, reinforcing gender disparities rather than removing them. Similarly, predictive policing tools rely on historical crime data shaped by years of racially biased policing. These algorithms don’t just inherit that bias—they amplify it, creating cycles of over-policing in marginalized communities. These cases emphasize that bias isn’t just a flaw in datasets, but often stems from unchallenged human assumptions. Recognizing this, and actively working to question and correct both our own blind spots and the flaws in the data we rely on, is essential for building AI systems that serve everyone fairly.</p>
<p><br>
<br>
</p>
<p>Consider carefully the ethical implications of choices we make when using data, and the impacts of our work on individuals and society.</p>
<p>Amazon AI Hiring Tool:<strong><br>
</strong>The ethical implications of Amazon’s AI hiring tool highlight the importance of scrutinizing how data choices can shape real-world outcomes. At face value, automating the hiring process promised efficiency and objectivity, but in reality, it reproduced and institutionalized gender bias present in the company’s past hiring patterns. The decision to train the algorithm on resumes of previously successful applicants ignored the possibility that historical decisions might have excluded qualified women. This oversight had tangible consequences: women’s resumes were systematically rated lower, reinforcing a biased notion of what a “qualified” applicant looks like. This example demonstrates how even subtle design choices—like which data to include or which features to emphasize—can lead to ethical missteps that affect individual opportunities and contribute to broader patterns of exclusion in the workforce.</p>
<p>Predictive Policing Algorithms:<strong><br>
</strong>The use of predictive policing algorithms underscores how data-driven decisions can deeply affect communities and reinforce systemic injustice. By basing predictions on historical arrest data, these systems essentially codify decades of racially biased policing into digital form. The impact goes beyond inaccurate forecasts—it determines where police are sent, who is surveilled, and ultimately who is criminalized. The ethical failure lies in treating biased data as objective truth, without accounting for the societal structures that shaped that data. This kind of technological decision-making not only affects individuals who are unfairly targeted but also erodes trust in public institutions and perpetuates a cycle of marginalization. It’s a stark reminder that the choices we make when building and deploying data systems have far-reaching consequences that extend well beyond technical performance.</p>
<p><br>
<br>
</p>
<p>Be open to changing our methods and conclusions in response to new knowledge.</p>
<p>The value of being open to changing methods and conclusions in response to new knowledge is exemplified by Amazon’s decision to shut down its AI hiring tool after recognizing its embedded gender bias. Once the company identified that the system was unfairly penalizing resumes containing female-associated terms, they chose not to move forward with its deployment—even though the tool likely showed strong performance in other areas. This decision reflects a willingness to confront uncomfortable truths, reevaluate their approach, and prioritize fairness over automation. In contrast, predictive policing programs have continued to operate despite mounting evidence that they disproportionately target marginalized communities and reinforce systemic racism. Rather than pause or reconsider their deployment, many law enforcement agencies have persisted in using these tools, often citing their efficiency while overlooking the deep social costs. This contrast highlights the ethical divide between organizations willing to evolve in light of new understanding and those that continue harmful practices under the guise of technological progress.</p>
<p><br>
<br>
<br>
<br>
</p>
<p>After writing the above content my mom came across another article related to these concepts which I thought was exceptionally intriguing so I have decided to add an additional couple paragraphs addressing a few of the earlier questions/values but with the new situation. The new example I am focusing on is the facial recognition AI program by Clearview AI. Clearview scraped billions of photos off of social media platforms without the consent of the platforms or the individuals and was actually fined tens of millions of dollars by multiple countries for disregarding privacy laws while creating their database. So clearly when looking at whether this data should be utilized it absolutely should not as there has been no consent to its acquisition and therefore its use. Yet the USA instead of imposing fines or attempting to restrict Clearview has implemented their technology in major branches of government. Similarly to predictive policing, this data is mainly utilized in law enforcement agencies, specifically ICE and the FBI. Also similarly, this data is mainly utilized to surveil marginalized populations (Business &amp; Human Rights Resource Centre) along the borders and within the United States.&nbsp;</p>
<p>There are a couple of clear issues with this technology, beginning with the concept of over policing a certain demographic will lead to more violations, which leads to more policing and overall the same feedback loop found in predictive policing. This feedback loop would further promote negative stereotypes of migrants entering the US, which may be the goal of ICE as they would in turn receive more funding. Then the most disturbing issue being the&nbsp;</p>
<p><br>
</p>
<p>In conclusion maybe I should have discussed data collection because I had a general assumption that legislation was being slowly implemented to prevent programs such as this but I am clearly wrong. Illegal data collection will continue to be an enormous issue especially if the government financially supports it and puts millions of dollars into their contracts.&nbsp;</p>
<p><br>
<br>
</p>
<p>Amazon hiring tool:&nbsp;</p>
<p><a href="https://www.reuters.com/article/us-amazon-com-jobs-automation-insight-idUSKCN1MK08G/" class="uri">https://www.reuters.com/article/us-amazon-com-jobs-automation-insight-idUSKCN1MK08G/</a>&nbsp;</p>
<p><br>
</p>
<p>MIT tech review(predictive policing):&nbsp;</p>
<p><a href="https://www.technologyreview.com/2021/02/05/1017560/predictive-policing-racist-algorithmic-bias-data-crime-predpol/#:~:text=It%27s%20no%20secret%20that%20predictive,lessen%20bias%20has%20little%20effect" class="uri">https://www.technologyreview.com/2021/02/05/1017560/predictive-policing-racist-algorithmic-bias-data-crime-predpol/#:~:text=It%27s%20no%20secret%20that%20predictive,lessen%20bias%20has%20little%20effect</a>.&nbsp;</p>
<p><br>
</p>
<p>Clearview AI facial recognition:</p>
<p><a href="https://www.business-humanrights.org/es/%C3%BAltimas-noticias/clearview-ais-facial-recognition-technology-designed-for-surveillance-of-marginalized-groups-report-reveals/" class="uri">https://www.business-humanrights.org/es/%C3%BAltimas-noticias/clearview-ais-facial-recognition-technology-designed-for-surveillance-of-marginalized-groups-report-reveals/</a>&nbsp;</p>
<p><a href="https://www.forbes.com/sites/roberthart/2024/09/03/clearview-ai-controversial-facial-recognition-firm-fined-33-million-for-illegal-database/" class="uri">https://www.forbes.com/sites/roberthart/2024/09/03/clearview-ai-controversial-facial-recognition-firm-fined-33-million-for-illegal-database/</a>&nbsp;</p>
<p><br>
<br>
</p>
<p>More examples:&nbsp;</p>
<p><a href="https://www.ibm.com/think/topics/shedding-light-on-ai-bias-with-real-world-examples" class="uri">https://www.ibm.com/think/topics/shedding-light-on-ai-bias-with-real-world-examples</a>&nbsp;</p>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>